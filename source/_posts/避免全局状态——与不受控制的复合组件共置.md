---
title: é¿å…å…¨å±€çŠ¶æ€â€”â€”ä¸ä¸å—æ§åˆ¶çš„å¤åˆç»„ä»¶å…±ç½®
date: 2023-03-19
---

å‡ºäºæ‰€æœ‰æœ€å¥½çš„æ„å›¾ï¼Œä»£ç åº“é€šå¸¸æœ€ç»ˆä¼šå˜æˆä¸€ä¸ªç”±ç»„ä»¶ã€æŠ½è±¡å’Œå…¨å±€çŠ¶æ€ï¼ˆç”±ç¬¬ä¸‰æ–¹åº“ç®¡ç†ï¼‰ç»„æˆçš„é”™ç»¼å¤æ‚çš„ç½‘ç»œï¼Œä½¿æœ€å°çš„æ›´æ”¹æˆä¸ºæ´»ç”Ÿç”Ÿçš„å™©æ¢¦ï¼Œè€Œç»´æŠ¤åˆ™æˆä¸ºä¸€ç§å¹³è¡¡è¡Œä¸ºã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç»å¸¸å¬åˆ°äººä»¬è°ˆè®ºé¿å…æŠ½è±¡ï¼Œä½†æ˜¯å¦‚ä½•å‘¢ï¼Ÿæœ‰æ—¶æˆ‘ä»¬éœ€è¦æå‡è¯¥çŠ¶æ€ä»¥å…±äº«å®ƒï¼Œæˆ–è€…å°†è¯¥ç»„ä»¶æ”¾åœ¨æ ‘ä¸­æ›´é«˜çš„ä½ç½®ä»¥ä¾¿åº”ç”¨ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†å¯ä»¥æ§åˆ¶å®ƒâ€¦â€¦å¯¹å—ï¼Ÿâ€¦â€¦ğŸ¤”

è¿™äº›å¹´æ¥ï¼Œæˆ‘å¯¹æ‰˜ç®¡ä»¥åŠå¦‚ä½•æœ‰æ•ˆåœ°å°†è¿™ä¸€åŸåˆ™åº”ç”¨åˆ°æˆ‘æ„å»ºçš„ç»„ä»¶è¿›è¡Œäº†å¾ˆå¤šæ€è€ƒã€‚æˆ‘å¼€å§‹æ³¨æ„åˆ°æˆ‘çš„å·¥ä½œä¸­å‡ºç°äº†ä¸€ç§æ¨¡å¼ï¼Œæˆ‘æƒ³åˆ†äº«å®ƒä»¥åŠå®ƒå¦‚ä½•å¸®åŠ©ç¼“è§£ä¸Šè¿°ç—›è‹¦ã€‚

ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£æ‰˜ç®¡æ„å‘³ç€ä»€ä¹ˆã€‚

## åˆ°åº•ä»€ä¹ˆæ˜¯æ‰˜ç®¡ï¼Ÿ

Kent C. Dodds æœ‰ä¸€ç¯‡å…³äºè¯¥ä¸»é¢˜çš„[ç²¾å½©æ–‡ç« ](https://kentcdodds.com/blog/colocation)ï¼Œä»–ä»¥ä»£ç æ³¨é‡Šä¸ºä¾‹ã€‚ä»–è¯¦ç»†è¯´æ˜äº†å¦‚æœè§£é‡Šä¸€æ®µä»£ç çš„æ³¨é‡Šç›´æ¥ä½äºå®ƒæ‰€è§£é‡Šçš„ä»£ç ä¹‹ä¸Šï¼Œé‚£ä¹ˆç†è§£ä¸€æ®µä»£ç æ˜¯å¦‚ä½•å˜å¾—æ›´å®¹æ˜“çš„ã€‚ä»»ä½•å…¶ä»–åœ°æ–¹ï¼ˆä¾‹å¦‚å¦ä¸€ä¸ªæ–‡ä»¶ï¼‰éƒ½ä¼šä½¿ä»£ç æ›´éš¾ç†è§£ï¼Œå¹¶ä¸”æ›´æ”¹ä»£ç å¾ˆå®¹æ˜“ä½¿è¯¥æ³¨é‡Šå˜å¾—å¤šä½™è€Œæ²¡æœ‰äººæ„è¯†åˆ°ã€‚

ä»–å°†æ‰˜ç®¡æè¿°ä¸ºå°†ä»£ç æ”¾ç½®åœ¨å°½å¯èƒ½é è¿‘å®ƒå°½å¯èƒ½ç›¸å…³çš„åœ°æ–¹ã€‚

> ä¸€èµ·å˜åŒ–çš„äº‹ç‰©åº”è¯¥å°½å¯èƒ½é è¿‘ã€‚

## React ä¸­çš„æ‰˜ç®¡

æˆ‘æ„è¯†åˆ°æˆ‘çš„åŒé¾„äººå’Œæˆ‘æ­£åœ¨çŠ¯è§„çš„ä¸€ä»¶å¸¸è§äº‹æƒ…æ˜¯å¯¹ DRY çš„å¼ºçƒˆæ¸´æœ›ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ª `<Dialog>` ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›éœ€è¦ä»æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†æ‰“å¼€çš„å†…å®¹ï¼Œæˆ‘ä»¬è®¤ä¸ºâ€œå¥½å§ï¼Œæˆ‘ä¸æƒ³å°†ç›¸åŒçš„å†…å®¹æ”¾åœ¨å¤šä¸ªåœ°æ–¹ï¼Œé‚£ä¸æ˜¯ DRYâ€ã€‚æ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨ `App` ï¼ˆæˆ–ç±»ä¼¼çš„ï¼‰ä¸­ï¼Œè¿æ¥ä¸€äº›å…¨å±€çŠ¶æ€å¹¶å…è®¸æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†æ›´æ”¹è¯¥çŠ¶æ€ã€‚æŠ½è±¡å¼€å§‹ã€‚

ç„¶åæˆ‘çªç„¶æƒ³åˆ°æˆ‘ä»¬ä¸€ç›´éƒ½çŸ¥é“çš„äº‹æƒ…ï¼Œä½†ç”±äºæŸç§åŸå› åœ¨å°†åº”ç”¨ç¨‹åºè¿æ¥åœ¨ä¸€èµ·æ—¶å¾€å¾€ä¼šå¿½ç•¥å®ƒã€‚ç»„ä»¶å¯é‡å¤ä½¿ç”¨ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†æˆ‘ä»¬çš„å†…å®¹ä»æ§åˆ¶å®ƒçš„åœ°æ–¹ç§»å¼€å¹¶å¼•å…¥ä¸€å †å…¨å±€çŠ¶æ€æ¥é‡ç”¨æŸäº›ä¸œè¥¿ï¼Ÿ

å¦‚æœæˆ‘ä»¬é€šè¿‡å°† UI çš„é‡å¤ä½¿ç”¨éƒ¨åˆ†æ†ç»‘åˆ°å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„å¤šä¸ªä½ç½®ä½¿ç”¨çš„ç»„ä»¶æ¥åº”ç”¨ DRYï¼Œè€Œä¸æ˜¯ä»å¤šä¸ªä½ç½®æ§åˆ¶ç»„ä»¶çš„å•ä¸ªå®ä¾‹ï¼Œä¼šæ€æ ·ï¼Ÿ

è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡å°è¯•ï¼š

{% iframe https://codesandbox.io/embed/avoid-global-state-colocate-demo-1-fv2uy?fontsize=14&hidenavigation=1&theme=dark '100%' '500px' %}

æˆ‘åˆ›å»ºäº†ä¸€ä¸ªå¯é‡ç”¨çš„ `Dialog` ç»„ä»¶ï¼Œå®ƒå°è£…äº†æ‰€æœ‰å¯¹è¯æ¡†åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­çš„å¤–è§‚å’Œè¡Œä¸ºæ–¹å¼ï¼Œä½†éšåæˆ‘ä¸ºæ‰€æœ‰éœ€è¦çš„åé¦ˆå†…å®¹ã€æ ·å¼å’Œé€»è¾‘åˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„ `Feedback` ç»„ä»¶ä»å¤šä¸ªåœ°æ–¹æ‰“å¼€ã€‚å®ƒåœ¨å†…éƒ¨å‘ˆç° `Dialog`ã€‚

ä¸è¿‡ï¼Œæ‚¨åœ¨è¿™é‡Œä¼šæ³¨æ„åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ç”¨æˆ·å¯ä»¥åŒæ—¶æ‰“å¼€ `Dialog` çš„å¤šä¸ªå®ä¾‹ã€‚æˆ‘ä»¬ä¸å¸Œæœ›è¿™æ ·ï¼Œå› ä¸ºæˆ‘ä»¬è¯•å›¾åšæŒå…±ç½®åŸåˆ™ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½æŠ½è±¡å‡ºä¸€äº›å…¨å±€çŠ¶æ€æ¥ç¡®ä¿ä¸€æ¬¡ä¸€ä¸ªã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨æ²¡æœ‰å…¨å±€çŠ¶æ€æˆ–å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªå¯é‡ç”¨å®ä¾‹çš„æƒ…å†µä¸‹å®ç°è¿™ä¸€ç›®æ ‡ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å®é™…éœ€è¦åšçš„æ˜¯åœ¨æœ‰äººå•å‡»å®ƒä¹‹å¤–çš„å†…å®¹æ—¶å…³é—­ `Dialog` ã€‚è®©æˆ‘ä»¬æŠŠå®ƒè¿æ¥èµ·æ¥ã€‚

```jsx
export const Dialog = ({ onClose, ...props }) => {
  const ref = React.useRef();

  React.useEffect(() => {
    const handleClick = event => {
      const dialog = ref.current;
      if (!dialog?.contains(event.target)) {
        onClose();
      }
    };
    document.addEventListener('click', handleClick, { capture: true });
    return () => {
      document.removeEventListener('click', handleClick, { capture: true });
    };
  });

  return ReactDOM.createPortal(<div {...props} ref={ref} />, document.body);
};
```

[https://codesandbox.io/s/avoid-global-state-colocate-demo-2-xtpgw](https://codesandbox.io/s/avoid-global-state-colocate-demo-2-xtpgw)

æˆ‘å·²ç»å‘ `Dialog` ç»„ä»¶æ·»åŠ äº†ä¸€äº› `document` ä¾¦å¬å™¨ï¼Œå› æ­¤ï¼Œé€šè¿‡å°è¯•æƒ³å‡ºé¿å…å…¨å±€çŠ¶æ€çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å·²ç»è®¾æ³•æ»¡è¶³ç»„ä»¶ä¸€æ¬¡åªå…è®¸æ‰“å¼€ä¸€ä¸ªçš„è¦æ±‚ã€‚

## æ›´å¤æ‚çš„æ¨¡å¼

æˆ‘å¼€å§‹æƒ³çŸ¥é“æ˜¯å¦æœ‰æ›´å¤æ‚çš„é—®é¢˜å¯ä»¥ä»è¿™ç§æ–¹æ³•ä¸­å—ç›Šï¼Œå¹¶å‘ç°è‡ªå·±å¿…é¡»æ„å»ºä¸€äº›é€šå¸¸ç”¨å…¨å±€çŠ¶æ€è§£å†³çš„é—®é¢˜â€”â€”ä¾§è¾¹æ ä¸­çš„å±æ€§é¢æ¿ã€‚æ‚¨çŸ¥é“ï¼Œæ‚¨åœ¨ Sketch ç­‰äº§å“ä¸­çœ‹åˆ°çš„ UI ç±»å‹ã€‚

![](https://zzh-cat.oss-cn-beijing.aliyuncs.com/picture/871db387-c21e-40ce-a9db-4f2a38258a19.jpg)

åœ¨è®¸å¤šåº”ç”¨ç¨‹åºä¸­ï¼Œé‚£äº›ä¾§é¢æ¿ä¸€ç›´æ˜¯æˆ‘ç”Ÿæ´»ä¸­çš„ç¥¸æ ¹ã€‚æˆ‘ä»¬åœ¨ `Main` ä¸­æ¸²æŸ“æŸäº›ä¸œè¥¿ï¼Œåœ¨ `Sidebar` ä¸­æ¸²æŸ“å±æ€§ï¼Œç„¶åç»§ç»­å¼•å…¥ä¸€å † `switch` å­å¥ï¼Œæ ¹æ®æˆ‘ä»¬çš„å…¨å±€çŠ¶æ€å‘Šè¯‰æˆ‘ä»¬åœ¨å±å¹•ä¸Šé€‰æ‹©çš„å†…å®¹æ¥ç¡®å®šè¦æ˜¾ç¤ºçš„å±æ€§ã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡å…¨å±€çŠ¶æ€æˆ–é“å…·é’»æ¢æ¥ä¼ è¾¾å±æ€§é€‰æ‹©ï¼Œä»¥æ”¹å˜å±å¹•ä¸Šäº‹ç‰©çš„å¤–è§‚ã€‚

å®ƒä¹Ÿæ˜¯ä»£ç å½¢å¼çš„ä¸€ç§ï¼Œå¹¶ä¸”è¿™äº›é€»è¾‘éƒ½ä¸ä¼šè¢«æ‘‡æ ‘ã€‚å¦‚æœæœ‰äººä»ä¸æ¸²æŸ“ `Rectangle` æ€ä¹ˆåŠï¼Ÿæ— è®ºå¦‚ä½•ï¼Œè¯¥é€»è¾‘å°†åˆ†å¸ƒåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä»¥å¤„ç†çŸ©å½¢ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚

## è§£å†³æ–¹æ¡ˆ

æˆ‘æƒ³çŸ¥é“å¦‚ä½•å°†æ‰˜ç®¡åº”ç”¨åˆ°åƒè¿™æ ·å¤æ‚çš„ä¸œè¥¿ä¸Šï¼Œæˆ‘é€šè¿‡åº”ç”¨ä¸ `Dialog` ç›¸åŒçš„æ€ç»´æ¥å¼„æ¸…æ¥šäº†ã€‚

å½“æˆ‘åªæƒ³é‡ç”¨ä¸æˆ‘çš„çŸ©å½¢ç›¸å…³çš„å†…å®¹æ—¶ï¼Œä¸ºä»€ä¹ˆæˆ‘è¦å°è¯•é‡ç”¨å•ä¸ª `PropertiesPanel` å®ä¾‹ï¼Œè¿™æ„å‘³ç€å®ƒå®é™…ä¸Šåªæ˜¯æˆ‘æƒ³é‡ç”¨çš„ä½ç½®ä½¿ç”¨ã€‚

æˆ‘ä»¬å·²ç»äº†è§£åˆ°ï¼Œç¬¬ä¸€ä¸ªè¦æ±‚æ˜¯é€šè¿‡ä¸ºçŸ©å½¢å¯ä»¥é‡å¤ä½¿ç”¨çš„æ¯ä¸ªå±æ€§é¢æ¿éƒ¨åˆ†åˆ›å»ºç»„ä»¶æ¥è§£å†³çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘å°†è¯¥ä»£ç ä¸ `Rectangle` ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œå®ƒå°±ä¸ä¼šåœ¨è¾¹æ ã€‚

æˆ–è€…å®ƒä¼š...åšæŒä¸‹å»ï¼Œæ— è®ºæˆ‘å•å‡»å“ªä¸ªæŒ‰é’®ï¼Œ `Dialog` éƒ½ä¼šåœ¨å±å¹•ä¸­é—´æ‰“å¼€ã€‚é—¨æˆ·ç½‘ç«™ï¼å¦‚æœæˆ‘ä»¬ä¸ºå±æ€§é¢æ¿å¯ä»¥è¿›å…¥çš„ä¾§è¾¹æ åˆ›å»ºä¸€ä¸ªç©ºç™½ç©ºé—´ï¼Œåˆ™æ‰˜ç®¡æ˜¯åŒæ­¥çš„ã€‚

è®©æˆ‘ä»¬å°† `Rectangle` æ„å»ºä¸ºå¤åˆç»„ä»¶ã€‚è¿™å…è®¸ä¸åŒçš„åº”ç”¨ç¨‹åºåœ¨å…¶åº”ç”¨ç¨‹åºéœ€è¦çš„ä»»ä½•åœ°æ–¹è®¿é—®å±æ€§é¢æ¿ï¼Œå› ä¸ºå®ƒå°†ä½œä¸ºå•ç‹¬çš„éƒ¨åˆ†å…¬å¼€ã€‚

```jsx
import {
  Styler,
  StylerSize,
  StylerBackgroundColor,
  StylerBorder,
  // StylerTextShadow - not necessary in Rectangle so will be tree-shaken
} from './Styler';

const RectangleContext = React.createContext({});

export const Rectangle = ({ children }) => {
  const ref = React.useRef(null);
  const [style, setStyle] = React.useState({});
  const [selected, setSelected] = React.useState(false);

  React.useEffect(() => {
    // click outside logic to set `selected` to `false`
  });

  return (
    <RectangleContext.Provider
      value={React.useMemo(
        () => ({ selected, style, onStyleChange: setStyle }),
        [style, selected],
      )}
    >
      <div style={style} ref={ref} onClick={() => setSelected(true)}>
        {children}
      </div>
    </RectangleContext.Provider>
  );
};

export const RectangleStyler = () => {
  const context = React.useContext(RectangleContext);
  return context.selected ? (
    <Styler style={context.style} onStyleChange={context.onStyleChange}>
      <StylerSize />
      <StylerBackgroundColor />
      <StylerBorder />
    </Styler>
  ) : null;
};
```

`Rectangle` ä½¿ç”¨è‡ªå®šä¹‰æ„å»ºçš„ `Styler` ç»„ä»¶ï¼Œè¯¥ç»„ä»¶æ ¹æ®åœ¨å…¶ä¸­å‘ˆç°çš„å±æ€§è¿”å›æ ·å¼å¯¹è±¡ã€‚å½“è¿™äº›å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬æ›´æ–°çŸ©å½¢ä¸Šçš„ `style` å±æ€§ã€‚

åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„ Sketch å…‹éš†ä¸­ä½¿ç”¨å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª `SidebarPortal` ç»„ä»¶æ¥åŒ…è£…æˆ‘ä»¬çš„ `RectangleStyler` å¹¶å°†å…¶å‘ˆç°åœ¨ä¾§è¾¹æ ä¸­ã€‚

```jsx
const SidebarContext = React.createContext([]);

export const SidebarProvider = props => {
  const sidebarState = React.useState(null);
  return <SidebarContext.Provider value={sidebarState} {...props} />;
};

export const Sidebar = () => {
  const [, setSidebar] = React.useContext(SidebarContext);
  return <div ref={setSidebar} />;
};

export const SidebarPortal = ({ children }) => {
  const [sidebar] = React.useContext(SidebarContext);
  return sidebar ? ReactDOM.createPortal(children, sidebar) : null;
};
```

ç„¶åæˆ‘ä»¬æŠŠå®ƒå…¨éƒ¨æ¶ˆè€—æ‰ï¼š

```jsx
// Main.js
export const Main = () => (
  <main>
    <Rectangle>
      <SidebarPortal>
        <RectangleStyler />
      </SidebarPortal>
    </Rectangle>
  </main>
);

// App.js
export const App = () => (
  <div>
    <SidebarProvider>
      <Main />
      <Sidebar />
    </SidebarProvider>
  </div>
);
```

å•å‡» `Rectangle` åœ¨è¾¹æ ä¸­æ‰“å¼€å…¶å±æ€§ã€‚å¯æ˜¯ç­‰ç­‰ã€‚å½“æˆ‘ä»¬ä¸ä¾§è¾¹æ ä¸­çš„æ ·å¼å™¨äº¤äº’æ—¶ï¼Œå®ƒä¼šå…³é—­ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œå…¨éƒ¨å°è¯•ã€‚

è¿™æ˜¯å› ä¸ºå•å‡»å¤–éƒ¨é€»è¾‘ã€‚æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ `rectangle.contains` æ¥æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨çŸ©å½¢ä¹‹å¤–ä»¥åŠæ ·å¼å™¨æ˜¯å¦åœ¨çŸ©å½¢ä¹‹å¤–ã€‚å®ƒåœ¨ä¾§è¾¹æ ä¸­ã€‚

å¹¸è¿çš„æ˜¯ï¼ŒReact æœ‰ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„åŠŸèƒ½ï¼Œå®ƒå¾ˆå°‘å—åˆ°ç§°èµï¼Œä½†åœ¨åƒè¿™æ ·è¿›è¡Œæ‰˜ç®¡æ—¶éå¸¸æœ‰ç”¨ã€‚ React äº‹ä»¶åœ¨ React æ ‘ä¸­å†’æ³¡ï¼Œæ— è®ºå®ƒä»¬åœ¨ DOM ä¸­çš„ä½•å¤„å‘ˆç°ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥é˜²æ­¢ä¾§è¾¹æ ä¸­çš„ç‚¹å‡»å…³é—­æ ·å¼å™¨ã€‚

```jsx
export const Rectangle = ({ children }) => {
  const ref = React.useRef();
  const [style, setStyle] = React.useState({});
  const [selected, setSelected] = React.useState(false);
  const isClickInsideRef = React.useRef(false);

  React.useEffect(() => {
    const handleClick = () => {
      if (!isClickInsideRef.current) setSelected(false);
      isClickInsideRef.current = false;
    };
    document.addEventListener('click', handleClick);
    return () => {
      document.removeEventListener('click', handleClick);
    };
  });

  return (
    <RectangleContext.Provider
      value={React.useMemo(
        () => ({ selected, style, onStyleChange: setStyle }),
        [style, selected],
      )}
    >
      <div
        style={style}
        ref={ref}
        onClick={() => setSelected(true)}
        onClickCapture={() => (isClickInsideRef.current = true)}
      >
        {children}
      </div>
    </RectangleContext.Provider>
  );
};
```

æˆ‘ä»¬é€šè¿‡ React å•å‡»äº‹ä»¶è®¾ç½®äº†ä¸€ä¸ª `isClickInside` å¸ƒå°”å€¼ã€‚å¦‚æœç‚¹å‡»åœ¨ `RectangleStyler` ä¸­ï¼Œè¿™å°†æ˜¯ `true` å› ä¸ºå®ƒå°†æ˜¯ React Tree ä¸­çš„ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶ä¸”å®ƒçš„ç‚¹å‡»å°†ä¼ æ’­åˆ° `Rectangle` ã€‚

{% iframe https://codesandbox.io/embed/avoid-global-state-colocate-demo-4-ohm7d?fontsize=14&hidenavigation=1&theme=dark '100%' '500px' %}

è¿™ç§æ–¹æ³•å°†å‡å°‘ä»£ç åº“ä¸­çš„ä¸€ç³»åˆ—å¤æ‚æ€§ã€‚ `PropertiesPanel` å®ä¾‹ä¸­ä¸å†æœ‰ `switch` è¯­å¥ã€‚ä¸å†æœ‰å°†æ ·å¼é€‰æ‹©è¿æ¥åˆ°çŸ©å½¢çš„å…¨å±€çŠ¶æ€ã€‚å¦‚æœä½¿ç”¨ `React.lazy` æœ‰æ¡ä»¶åœ°æ¸²æŸ“ `Rectangle` ï¼Œä¸€åˆ‡éƒ½å°†è¢«æ‘‡æ ‘ã€‚å®ƒè¿˜é¿å…äº†åœ¨å…¶ä»–ç»„ä»¶ä¸­ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“â€”â€”å¦‚æœæ‚¨æ­£åœ¨æ›´æ”¹ `RectangleStyler` ï¼Œåˆ™åªä¼šé‡æ–°æ¸²æŸ“çŸ©å½¢éƒ¨åˆ†ã€‚

## æ›´è¿›ä¸€æ­¥

æˆ‘ä»¬ç›®å‰ä¸€ç›´åœ¨æ¸²æŸ“è¿™ä¸ªçŸ©å½¢ï¼Œä½†åœ¨ç±»ä¼¼ Sketch çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™é€šå¸¸ä¼šé€šè¿‡â€œæ·»åŠ çŸ©å½¢â€æŒ‰é’®æ·»åŠ ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŸç§çŠ¶æ€å°†è¯¥é€»è¾‘æ·»åŠ åˆ°æˆ‘ä»¬çš„ `App` ä¸­ï¼Œè¯¥çŠ¶æ€å†³å®š `Rectangle` æ˜¯å¦åº”è¯¥å‘ˆç°ï¼Œä½†è¿™æ„å‘³ç€è¯¥é€»è¾‘æœ€ç»ˆå¯èƒ½ä¼šä¸è¯¥ç»„ä»¶å®Œå…¨æ–­å¼€è¿æ¥ï¼Œæˆ‘ä»¬å°†å†æ¬¡å¤±å»æ‰˜ç®¡ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡å°† `Trigger` å°è£…ä¸º `Rectangle` ç»„ä»¶çš„ä¸€éƒ¨åˆ†æ¥åšæ›´å¤šçš„äº‹æƒ…ï¼Œå¹¶åœ¨å•å‡»æ—¶é‡æ–°ä½¿ç”¨é—¨æˆ·æŠ€æœ¯åœ¨ `Main` ä¸­å‘ˆç° `Rectangle` ã€‚

{% iframe https://codesandbox.io/embed/avoid-global-state-colocate-demo-5-xylij?fontsize=14&hidenavigation=1&theme=dark '100%' '500px' %}

## ä¸å—æ§åˆ¶çš„å¤åˆæˆåˆ†

æˆ‘å·²ç»å¼€å§‹å°† React ä¸­çš„è¿™ç§æ‰˜ç®¡æŠ€æœ¯ç§°ä¸ºä¸å—æ§åˆ¶çš„å¤åˆç»„ä»¶æ¨¡å¼ã€‚è¿™äº›ç»„ä»¶å¯ä»¥å®Œæˆä¸å…¶å…³æ³¨ç›¸å…³çš„æ‰€æœ‰äº‹æƒ…ï¼Œè€Œæ— éœ€æ‚¨æ‰‹åŠ¨è¿æ¥å®ƒä»¬æ¥ä½¿ç”¨å®ƒä»¬ã€‚æ²¡æœ‰çŠ¶æ€ï¼Œæ²¡æœ‰å‚è€ƒã€‚ä¸€åˆ‡æ­£å¸¸â„¢ã€‚

æˆ‘ä»¬åœ¨ [Modulz](https://www.modulz.app/) çš„ [Radix Primitives](https://www.radix-ui.com/docs/primitives/overview/introduction) å›¢é˜Ÿä¸­é‡‡ç”¨äº†è¿™ç§æ–¹æ³•æ¥å°è£…å¸¸è§ Web ç»„ä»¶çš„å¯è®¿é—®æ€§å’ŒåŠŸèƒ½è¦æ±‚ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥å¿«é€Ÿå¯åŠ¨å’Œè¿è¡Œã€‚

ä¸‹é¢æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ `Dialog` ä½œä¸º `Feedback` ç»„ä»¶æ¥åº”ç”¨å…±ç½®åŸåˆ™ã€‚

```jsx
import * as Dialog from '@radix-ui/react-dialog';

export const Feedback = ({ children, ...props }) => (
  <Dialog.Root>
    <Dialog.Trigger asChild>{children}</Dialog.Trigger>
    <Dialog.Content {...props}>
      <h2>Thoughts?</h2>
      <form>
        <textarea />
        <button>Submit feedback</button>
      </form>
      <Dialog.Close>Close</Dialog.Close>
    </Dialog.Content>
  </Dialog.Root>
);

// render (
// 	<Feedback>
//		<PrimaryButton>Feedback</PrimaryButton>
//	</Feedback>
//
//  ...
//
// 	<Feedback>
//		<SecondaryButton>Feedback</SecondaryButton>
//	</Feedback>
// )
```

## ç»“è®º

æ‰˜ç®¡å¯ä»¥æ˜¾ç€é™ä½å¤æ‚æ€§ã€‚æˆ‘çœŸçš„å¸Œæœ›è¿™èƒ½å¯å‘æ‚¨é€šè¿‡æ”¯æŒç»„ä»¶é‡ç”¨è€Œä¸æ˜¯å®ä¾‹é‡ç”¨åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­åº”ç”¨è¯¥åŸåˆ™ã€‚

## å‚è€ƒ

[Avoid Global State â€” Co-locate with Uncontrolled Compound Components](https://jjenzz.com/avoid-global-state-colocate)



